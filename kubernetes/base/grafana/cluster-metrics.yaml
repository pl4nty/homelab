apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: kubelet-monitor
  namespace: grafana
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    honorLabels: true
    interval: 60s
    metricRelabelings:
    - action: keep
      regex: "go_goroutines|\
        kubelet_cgroup_manager_duration_seconds_bucket|\
        kubelet_cgroup_manager_duration_seconds_count|\
        kubelet_node_config_error|\
        kubelet_node_name|\
        node_quantile:kubelet_pleg_relist_duration_seconds:histogram_quantile|\
        kubelet_pleg_relist_duration_seconds_bucket|\
        kubelet_pleg_relist_duration_seconds_count|\
        kubelet_pleg_relist_interval_seconds_bucket|\
        kubelet_certificate_manager_client_ttl_seconds|\
        kubelet_certificate_manager_client_expiration_renew_errors|\
        kubelet_certificate_manager_server_ttl_seconds|\
        kubelet_pod_start_duration_seconds_bucket|\
        kubelet_pod_start_duration_seconds_count|\
        kubelet_pod_worker_duration_seconds_bucket|\
        kubelet_pod_worker_duration_seconds_count|\
        kubelet_server_expiration_renew_errors|\
        kubelet_running_containers|\
        kubelet_running_container_count|\
        kubelet_running_pods|\
        kubelet_running_pod_count|\
        kubelet_runtime_operations_errors_total|\
        kubelet_runtime_operations_total|\
        kubelet_volume_stats_available_bytes|\
        kubelet_volume_stats_capacity_bytes|\
        kubelet_volume_stats_inodes|\
        kubelet_volume_stats_inodes_used|\
        process_cpu_seconds_total|\
        rest_client_request_duration_seconds_bucket|\
        rest_client_requests_total|\
        storage_operation_duration_seconds_count|\
        storage_operation_errors_total|\
        kubernetes_build_info|\
        volume_manager_total_volumes|\
        process_resident_memory_bytes"
      sourceLabels:
      - __name__
    port: https-metrics
    relabelings:
    - sourceLabels:
      - __metrics_path__
      targetLabel: metrics_path
    - action: replace
      targetLabel: job
      replacement: integrations/kubernetes/kubelet
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
  namespaceSelector:
    matchNames:
    - default
  selector:
    matchLabels:
      app.kubernetes.io/name: kubelet
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: cadvisor-monitor
  namespace: grafana
spec:
  endpoints:
  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token
    honorLabels: true
    honorTimestamps: false
    interval: 60s
    metricRelabelings:
    - action: keep
      regex: "container_cpu_cfs_periods_total|\
        container_cpu_cfs_throttled_periods_total|\
        container_cpu_usage_seconds_total|\
        container_fs_inodes_free|\
        container_fs_inodes_total|\
        container_fs_limit_bytes|\
        container_fs_usage_bytes|\
        container_fs_reads_bytes_total|\
        container_fs_reads_total|\
        container_fs_writes_bytes_total|\
        container_fs_writes_total|\
        container_memory_cache|\
        container_memory_rss|\
        container_memory_swap|\
        container_memory_working_set_bytes|\
        container_network_receive_bytes_total|\
        container_network_receive_packets_dropped_total|\
        container_network_receive_packets_total|\
        container_network_transmit_bytes_total|\
        container_network_transmit_packets_dropped_total|\
        container_network_transmit_packets_total|\
        container_start_time_seconds|\
        machine_memory_bytes|\
        node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate|\
        node_namespace_pod_container:container_cpu_usage_seconds_total:sum_irate|\
        node_namespace_pod_container:container_memory_cache|\
        node_namespace_pod_container:container_memory_swap|\
        node_namespace_pod_container:container_memory_rss|\
        node_namespace_pod_container:container_memory_working_set_bytes|\
        process_resident_memory_bytes|\
        container_memory_usage_bytes"
      sourceLabels:
      - __name__
    path: /metrics/cadvisor
    port: https-metrics
    relabelings:
    - sourceLabels:
      - __metrics_path__
      targetLabel: metrics_path
    - action: replace
      targetLabel: job
      replacement: integrations/kubernetes/cadvisor
    scheme: https
    tlsConfig:
      insecureSkipVerify: true
  namespaceSelector:
    matchNames:
    - default
  selector:
    matchLabels:
      app.kubernetes.io/name: kubelet
---
apiVersion: monitoring.grafana.com/v1alpha1
kind: PodLogs
metadata:
  name: kubernetes-logs
  namespace: grafana
spec:
  namespaceSelector:
    any: true
  pipelineStages:
  - cri: {}
  relabelings:
  - sourceLabels:
    - __meta_kubernetes_pod_node_name
    targetLabel: __host__
  - action: labelmap
    regex: __meta_kubernetes_pod_label_(.+)
  - action: replace
    sourceLabels:
    - __meta_kubernetes_namespace
    targetLabel: namespace
  - action: replace
    sourceLabels:
    - __meta_kubernetes_pod_name
    targetLabel: pod
  - action: replace
    sourceLabels:
    - __meta_kubernetes_container_name
    targetLabel: container
  - replacement: /var/log/pods/*$1/*.log
    separator: /
    sourceLabels:
    - __meta_kubernetes_pod_uid
    - __meta_kubernetes_pod_container_name
    targetLabel: __path__
  - action: labeldrop
    regex: app_kubernetes_io_name
  selector:
    matchLabels: {}
