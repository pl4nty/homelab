apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: k8s-monitoring
  namespace: monitoring-system
spec:
  interval: 15m
  chart:
    spec:
      chart: k8s-monitoring
      version: 0.9.2
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
    crds: CreateReplace
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
    crds: CreateReplace
  uninstall:
    keepHistory: false
  values:
    cluster:
      name: ${CLUSTER_NAME:=bootstrap}
    externalServices:
      prometheus:
        host: ${METRICS_HOST}
        basicAuth:
          username: ${METRICS_USERNAME}
          password: ${METRICS_PASSWORD}
      loki:
        host: ${LOGS_HOST}
        basicAuth:
          username: ${LOGS_USERNAME}
          password: ${LOGS_PASSWORD}
    # https://github.com/grafana/k8s-monitoring-helm/issues/46#issuecomment-1668986219
    opencost:
      enabled: false
    logs:
      pod_logs:
        namespaces:
          - backup-system
          - cnpg-system
          - default
          - monitoring-system
      extraConfig: |-
        loki.source.syslog "syslog_udp" {
          listener {
            address = "0.0.0.0:514"
            protocol = "udp"
            labels = { job = "integrations/syslog_exporter" }
          }

          forward_to = [loki.write.grafana_cloud_loki.receiver]
        }
    grafana-agent-logs:
      agent:
        extraPorts:
          - name: syslog-udp
            port: 514
            targetPort: 514
            protocol: UDP
    metrics:
      extraMetricRelabelingRules: |-
        rule {
          source_labels = ["__name__","mountpoint"]
          separator = "@"
          regex = "node_filesystem.*@/run/"
          action = "drop"
        }
        rule {
          source_labels = ["namespace", "pod"]
          separator = "@"
          regex = "flux-system@(.+)-.+-.+"
          target_label = "pod"
          replacement = "$1"
        }
