apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: k8s-monitoring
  namespace: monitoring-system
spec:
  interval: 15m
  chart:
    spec:
      chart: k8s-monitoring
      version: 0.2.4
      sourceRef:
        kind: HelmRepository
        name: grafana
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
    crds: CreateReplace
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
    crds: CreateReplace
  uninstall:
    keepHistory: false
  values:
    cluster:
      name: ${CLUSTER_NAME:=bootstrap}
    externalServices:
      prometheus:
        host: ${METRICS_HOST}
        basicAuth:
          username: ${METRICS_USERNAME}
          password: ${METRICS_PASSWORD}
      loki:
        host: ${LOGS_HOST}
        basicAuth:
          username: ${LOGS_USERNAME}
          password: ${LOGS_PASSWORD}
    # https://github.com/grafana/k8s-monitoring-helm/issues/46#issuecomment-1668986219
    opencost:
      enabled: false
    metrics:
      extraMetricRelabelingRules: |-
        rule {
          source_labels = ["__name__","image"]
          separator = "@"
          regex = "(container_cpu_.*|container_fs_.*|container_memory_.*|container_network_.*)@"
          action = "drop"
        }
        rule {
          source_labels = ["__name__","container"]
          separator = "@"
          regex = "(container_cpu_.*|container_fs_.*|container_memory_.*)@"
          action = "drop"
        }
        rule {
          source_labels = ["__name__"]
          regex = "container_cpu_.*|container_fs_.*|container_memory_.*|container_network_.*"
          target_label = "id"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          regex = "container_cpu_.*|container_fs_.*|container_memory_.*|container_network_.*"
          target_label = "image"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          regex = "container_cpu_.*|container_fs_.*|container_memory_.*|container_network_.*"
          target_label = "name"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          regex = "machine_memory_bytes"
          target_label = "boot_id"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          regex = "machine_memory_bytes"
          target_label = "system_uuid"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__", "device"]
          separator = "@"
          regex = "container_fs_.*@(/dev/)?(mmcblk.p.+|nvme.+|rbd.+|sd.+|vd.+|xvd.+|dasd.+)"
          target_label = "__keepme"
          replacement = "1"
        }
        rule {
          source_labels = ["__name__", "__keepme"]
          separator = "@"
          regex = "container_fs_.*@"
          action = "drop"
        }
        rule {
          source_labels = ["__name__"]
          regex = "container_fs_.*"
          target_label = "__keepme"
          replacement = ""
        }

        rule {
          source_labels = ["__name__", "interface"]
          separator = "@"
          regex = "container_network_.*@(en[ospx]|wlan|eth)[0-9].*"
          target_label = "__keepme"
          replacement = "1"
        }
        rule {
          source_labels = ["__name__", "__keepme"]
          separator = "@"
          regex = "container_network_.*@"
          action = "drop"
        }
        rule {
          source_labels = ["__name__"]
          regex = "container_network_.*"
          target_label = "__keepme"
          replacement = ""
        }

        rule {
          source_labels = ["__name__"]
          target_label = "uid"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          target_label = "image_id"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          target_label = "image"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          target_label = "image_spec"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_pod_info|kube_pod_owner"
          target_label = "created_by_name"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_pod_container_info"
          target_label = "container_id"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_pod_info"
          target_label = "host_ip"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_pod_info"
          target_label = "pod_ip"
          replacement = "NA"
        }
        rule {
          source_labels = ["__name__","reason"]
          separator = "@"
          regex = "kube_pod_status_reason@Evicted"
          target_label = "__keepme"
          replacement = "1"
        }
        rule {
          source_labels = ["__name__", "__keepme"]
          separator = "@"
          regex = "kube_pod_status_reason@"
          action = "drop"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_pod_status_reason"
          target_label = "__keepme"
          replacement = ""
        }
        rule {
          source_labels = ["__name__","phase"]
          separator = "@"
          regex = "kube_pod_status_phase@Unknown"
          target_label = "phase"
          replacement = "Failed"
        }
        rule {
          source_labels = ["__name__","phase"]
          separator = "@"
          regex = "kube_pod_status_phase@(Pending|Running|Failed)"
          target_label = "__keepme"
          replacement = "1"
        }
        rule {
          source_labels = ["__name__", "__keepme"]
          separator = "@"
          regex = "kube_pod_status_phase@"
          action = "drop"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_pod_status_phase"
          target_label = "__keepme"
          replacement = ""
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_replicaset.*"
          action = "drop"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_.*(annotations|labels|created)"
          action = "drop"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_pod_container_info"
          action = "drop"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_pod_container_status_restarts_total"
          action = "drop"
        }
        rule {
          source_labels = ["__name__"]
          regex = "kube_.*_status_replicas.*"
          action = "drop"
        }

        rule {
          source_labels = ["__name__", "fstype"]
          separator = "@"
          regex = "node_filesystem.*@tmpfs"
          action = "drop"
        }
        rule {
          source_labels = ["__name__","mountpoint"]
          separator = "@"
          regex = "node_filesystem.*@/"
          target_label = "__keepme"
          replacement = "1"
        }
        rule {
          source_labels = ["__name__","__keepme"]
          separator = "@"
          regex = "node_filesystem.*@"
          action = "drop"
        }

        rule {
          source_labels = ["namespace", "pod"]
          separator = "@"
          regex = "flux-system@(.+-).+-.+"
          target_label = "pod"
          replacement = "$1"
        }


      # rule {
      #   source_labels = ["__name__"]
      #   target_label = "exported_uid"
      #   replacement = "NA"
      # }
      # rule {
      #   source_labels = ["__name__"]
      #   regex = "container_network_.*"
      #   action = "drop"
      # }
      # rule {
      #   source_labels = ["__name__"]
      #   regex = "kube_pod_start_time"
      #   action = "drop"
      # }
