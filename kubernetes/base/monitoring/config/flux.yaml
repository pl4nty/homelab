apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: flux-system
  namespace: monitoring
spec:
  namespaceSelector:
    matchNames:
    - flux-system
  selector:
    matchExpressions:
    - key: app
      operator: In
      values:
        - helm-controller
        - source-controller
        - kustomize-controller
        - notification-controller
        - image-automation-controller
        - image-reflector-controller
  podMetricsEndpoints:
  - port: http-prom
    relabelings:
    # https://github.com/prometheus-operator/prometheus-operator/issues/4816
    - action: keep
      sourceLabels: [__meta_kubernetes_pod_phase]
      regex: Running
    metricRelabelings:
    - action: keep
      regex: "gotk_reconcile_condition|\
        gotk_reconcile_duration_seconds.*|\
        go_info|\
        workqueue_longest_running_processor_seconds|\
        go_memstats_alloc_bytes|\
        rest_client_requests_total|\
        process_cpu_seconds_total|\
        container_memory_working_set_bytes|\
        workqueue_longest_running_processor_seconds|\
        controller_runtime_reconcile_total|\
        controller_runtime_reconcile_time_seconds_bucket"
      # drop: go_.*|gotk_reconcile_duration_seconds_bucket|gotk_event_.*|gotk_receiver_.*
      sourceLabels:
      - __name__
    - action: labeldrop
      regex: instance
# notification CRD unsupported in AKS extension as of writing
# ---
# apiVersion: notification.toolkit.fluxcd.io/v1beta2
# kind: Alert
# metadata:
#   name: grafana
#   namespace: grafana
# spec:
#   providerRef:
#     name: grafana
#   eventSeverity: info
#   eventSources:
#     - kind: GitRepository
#       name: '*'
#       namespace: flux-system
# ---
# apiVersion: notification.toolkit.fluxcd.io/v1beta2
# kind: Provider
# metadata:
#   name: grafana
#   namespace: grafana
# spec:
#   type: grafana
#   address: "http://tplant.grafana.net/api/annotations"
#   secretRef:
#     name: annotation-token