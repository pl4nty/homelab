apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: opentelemetry-collector
  namespace: monitoring
spec:
  envFrom:
  - secretRef:
      name: opentelemetry-collector
  # targetAllocator:
  #   enabled: true
  #   prometheusCR:
  #     enabled: true
  config: |
    extensions:
      basicauth/traces:
        client_auth:
          username: $${env:TRACES_USERNAME}
          password: $${env:METRICS_PASSWORD}
      basicauth/metrics:
        client_auth:
          username: $${env:METRICS_USERNAME}
          password: $${env:METRICS_PASSWORD}
      basicauth/logs:
        client_auth:
          username: $${env:LOGS_USERNAME}
          password: $${env:METRICS_PASSWORD}

    exporters:
      otlp:
        endpoint: $${env:TRACES_ENDPOINT}
        tls:
          insecure: false
        auth:
          authenticator: basicauth/traces
      prometheusremotewrite:
        endpoint: $${env:METRICS_ENDPOINT}
        auth:
          authenticator: basicauth/metrics
        external_labels:
          cluster: ${env:CLUSTER_NAME}
      loki:
        endpoint: $${env:LOGS_ENDPOINT}
        auth:
          authenticator: basicauth/logs

    processors:
      spanmetrics:
        metrics_exporter: prometheusremotewrite

    service:
      extensions: [ basicauth/traces, basicauth/metrics, basicauth/logs, health_check, memory_ballast ]
      pipelines:
        metrics:
          exporters: [prometheusremotewrite]
        logs:
          receivers: [filelog]
          exporters: [loki]