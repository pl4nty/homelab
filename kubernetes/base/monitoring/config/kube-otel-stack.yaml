apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-otel-stack
  namespace: monitoring
spec:
  interval: 15m
  chart:
    spec:
      chart: kube-otel-stack
      version: 0.2.7
      sourceRef:
        kind: HelmRepository
        name: otel-collector
        namespace: flux-system
  install:
    timeout: 10m
    replace: true
    crds: CreateReplace
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      remediateLastFailure: true
      retries: 3
      strategy: rollback
    cleanupOnFail: true
    crds: CreateReplace
  test:
    enable: true
  rollback:
    recreate: true
    force: true
    cleanupOnFail: true
  uninstall:
    keepHistory: false
  maxHistory: 3
  values:
    metricsCollector:
      replicas: 1
      targetAllocator:
        replicas: 1
      env:
      - name: LS_TOKEN
        value: ""
      - name: GRAFANA_API_KEY
        valueFrom:
          secretKeyRef:
            key: TRACES_PASSWORD
            name: opentelemetry-collector
      - name: TRACES_USERNAME
        valueFrom:
          secretKeyRef:
            key: TRACES_USERNAME
            name: opentelemetry-collector
      - name: METRICS_USERNAME
        valueFrom:
          secretKeyRef:
            key: METRICS_USERNAME
            name: opentelemetry-collector
      - name: LOGS_USERNAME
        valueFrom:
          secretKeyRef:
            key: LOGS_USERNAME
            name: opentelemetry-collector
      - name: TRACES_ENDPOINT
        valueFrom:
          secretKeyRef:
            key: TRACES_ENDPOINT
            name: opentelemetry-collector
      - name: METRICS_ENDPOINT
        valueFrom:
          secretKeyRef:
            key: METRICS_ENDPOINT
            name: opentelemetry-collector
      - name: LOGS_ENDPOINT
        valueFrom:
          secretKeyRef:
            key: LOGS_ENDPOINT
            name: opentelemetry-collector
      - name: CLUSTER_NAME
        valueFrom:
          secretKeyRef:
            key: CLUSTER_NAME
            name: opentelemetry-collector
      config:
        extensions:
          basicauth/traces:
            client_auth:
              username: $${env:TRACES_USERNAME}
              password: $${env:GRAFANA_API_KEY}
          basicauth/metrics:
            client_auth:
              username: $${env:METRICS_USERNAME}
              password: $${env:GRAFANA_API_KEY}
          basicauth/logs:
            client_auth:
              username: $${env:LOGS_USERNAME}
              password: $${env:GRAFANA_API_KEY}
        processors:
          batch:
            send_batch_max_size: 10000
        exporters:
          otlp:
            endpoint: $${env:TRACES_ENDPOINT}
            auth:
              authenticator: basicauth/traces
            tls:
              insecure: false
          prometheusremotewrite:
            endpoint: $${env:METRICS_ENDPOINT}
            auth:
              authenticator: basicauth/metrics
            external_labels:
              cluster: $${env:CLUSTER_NAME}
          loki:
            endpoint: $${env:LOGS_ENDPOINT}
            auth:
              authenticator: basicauth/logs
        service:
          extensions:
          - health_check
          - basicauth/traces
          - basicauth/metrics
          - basicauth/logs
          pipelines:
            metrics:
              receivers: [prometheus]
              processors: [memory_limiter, resource, batch]
              exporters: [prometheusremotewrite]
            logs:
              receivers: [ filelog, k8s_events ]
              processors: [ batch ]
              exporters: [ loki ]
        k8s_events:
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: opentelemetry-events
rules:
# - apiGroups: [""]
#   resources:
#   - configmaps
#   verbs: ["get"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: opentelemetry-events
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: opentelemetry-events
subjects:
- kind: ServiceAccount
  name: kube-otel-stack-collector
  namespace: monitoring
