# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/app-template-3.2.1/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: mcc-mitm
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 3.3.2
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  values:
    controllers:
      main:
        containers:
          main:
            image:
              repository: nginx
              tag: alpine
            probes:
              liveness:
                enabled: true
              readiness:
                enabled: true
              startup:
                enabled: true
    configMaps:
      nginx:
        data:
          nginx.conf: |
            events {}

            http {
                log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                                '$status $body_bytes_sent "$http_referer" '
                                '"$http_user_agent" "$http_x_forwarded_for"';

                # Log to stdout
                access_log /dev/stdout main;

                # Add a resolver for dynamic domain names
                resolver 8.8.8.8 8.8.4.4 ipv6=off valid=300s;

                server {
                    listen 80;
                    server_name localhost;

                    location /filestreamingservice/files/c6b8cf6e-335a-4658-be1b-cae7575dd1ed/pieceshash {
                        default_type application/json;
                        return 200 '{"MajorVersion":1,"MinorVersion":0,"HashOfHashes":"example","ContentLength":1048576,"PieceSize":1048576,"Pieces":["J1oCG7+2SJ5U1HGJn3250WY/xpXsL+KixFOKq/ZR/Q8="]}';
                    }

                    location /filestreamingservice/files/c6b8cf6e-335a-4658-be1b-cae7575dd1ed {
                        return 206 'X5O!P%@AP[4\PZX54(P^)7CC)7}\$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!\$H+H*';
                    }

                    location / {
                        set $cacheHostOrigin "";

                        if ($arg_cacheHostOrigin) {
                            set $cacheHostOrigin $arg_cacheHostOrigin;
                        }

                        set $proxy_url http://$cacheHostOrigin$request_uri;
                        rewrite ^(.*)\?cacheHostOrigin=.*$ $1 break;

                        proxy_pass $proxy_url;

                        proxy_set_header Host $cacheHostOrigin;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    }
                }
            }
    service:
      # healthchecks fail without http path
      main:
        controller: main
        type: LoadBalancer
        annotations:
          external-mdns.blakecovarrubias.com/hostnames: example._microsoft_mcc._tcp
          external-mdns.blakecovarrubias.com/without-namespace: "true"
        ports:
          http:
            port: 80
    persistence:
      nginx:
        type: configMap
        name: "{{ .Release.Name }}-nginx"
        globalMounts:
        - path: /etc/nginx/nginx.conf
          subPath: nginx.conf

