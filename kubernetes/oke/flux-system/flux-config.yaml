apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: cluster-oke
  namespace: flux-system
spec:
  interval: 30m
  path: ./kubernetes/oke
  prune: true
  wait: false
  sourceRef:
    kind: GitRepository
    name: home-kubernetes
  decryption:
    provider: sops
    secretRef:
      name: sops-age
  postBuild:
    substituteFrom:
    - kind: ConfigMap
      name: cluster-settings
    - kind: Secret
      name: cluster-secrets
    - kind: ConfigMap
      name: instance-settings
# ---
# apiVersion: gateway.networking.k8s.io/v1alpha2
# kind: Gateway
# metadata:
#   name: flux-gateway
#   namespace: flux-system
# spec:
#   gatewayClassName: traefik
#   listeners:
#   - name: web
#     port: 8000
#     protocol: HTTP
#     allowedRoutes:
#       namespaces:
#         from: Same
# ---
# apiVersion: gateway.networking.k8s.io/v1alpha2
# kind: HTTPRoute
# metadata:
#   name: webhook-receiver
#   namespace: flux-system
# spec:
#   parentRefs:
#   - namespace: flux-system
#     name: flux-gateway
#   hostnames:
#   - flux-webhook.tplant.com.au
#   rules:
#   - backendRefs:
#     - name: webhook-receiver-2
#       port: 80
---
apiVersion: networking.cfargotunnel.com/v1alpha1
kind: TunnelBinding
metadata:
  name: webhook-receiver
  namespace: flux-system
subjects:
  - name: webhook-receiver
    spec:
      fqdn: flux-webhook.tplant.com.au
tunnelRef:
  kind: ClusterTunnel
  name: cloudflare-tunnel
