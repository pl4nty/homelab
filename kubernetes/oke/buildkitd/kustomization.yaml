apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: default
resources:
- buildkit-daemon-certs.sops.yaml
- https://raw.githubusercontent.com/moby/buildkit/v0.12.4/examples/kubernetes/deployment%2Bservice.rootless.yaml
- buildkitd-pvc.yaml
patchesStrategicMerge:
- |-
  apiVersion: v1
  kind: Service
  metadata:
    name: buildkitd
    annotations:
      service.beta.kubernetes.io/oci-load-balancer-shape: flexible
      service.beta.kubernetes.io/oci-load-balancer-shape-flex-min: "10"
      service.beta.kubernetes.io/oci-load-balancer-shape-flex-max: "10"
      external-dns.alpha.kubernetes.io/hostname: buildkitd.${PUBLIC_DOMAIN}
  spec:
    type: LoadBalancer
- |-
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: buildkitd
  spec:
    template:
      metadata:
        annotations:
          instrumentation.opentelemetry.io/inject-sdk: "true"
      spec:
        containers:
        - name: buildkitd
          resources:
            requests:
              cpu: 100m
              ephemeral-storage: 1Gi
            limits:
              cpu: 1
              ephemeral-storage: 6Gi
          livenessProbe:
            exec:
              command:
              - sh
              - -c
              - "exit 1"
            failureThreshold: 1
            periodSeconds: 3600
      volumes:
      - name: buildkitd
        persistentVolumeClaim:
          claimName: buildkitd-cache
# patches:
# - target:
#     group: apps
#     version: v1
#     kind: Deployment
#   patch: |-
#     - op: add
#       path: /spec/template/spec/containers/0/args/-
#       value: --debug  
