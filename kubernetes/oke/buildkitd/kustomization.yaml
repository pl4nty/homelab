apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: default
resources:
- buildkit-daemon-certs.sops.yaml
- https://raw.githubusercontent.com/moby/buildkit/v0.12.4/examples/kubernetes/statefulset.rootless.yaml
- buildkitd-svc.yaml
patchesStrategicMerge:
- |-
  apiVersion: apps/v1
  kind: StatefulSet
  metadata:
    name: buildkitd
  spec:
    serviceName: null
    template:
      metadata:
        annotations:
          instrumentation.opentelemetry.io/inject-sdk: "true"
      spec:
        securityContext:
          fsGroup: 1000
        containers:
        - name: buildkitd
          resources:
            requests:
              cpu: 100m
            limits:
              cpu: 1
          livenessProbe:
            timeoutSeconds: 5
        volumes:
        - name: buildkitd
          $patch: delete
    volumeClaimTemplates:
    - metadata:
      name: buildkitd
      spec:
        accessModes:
        - ReadWriteOnce
        resources:
          requests:
            storage: 16Gi
