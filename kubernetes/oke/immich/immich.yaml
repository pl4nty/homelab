apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: immich
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: immich
      version: 0.1.2
      sourceRef:
        kind: HelmRepository
        name: immich
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    env:
      DB_HOSTNAME: immich-cnpg-rw
      DB_DATABASE_NAME: immich
    envFrom:
    - secretRef:
        name: immich
    redis:
      enabled: true
      image:
        # default doesn't have ARM as of writing
        tag: 7.0.11-debian-11-r18
      master:
        persistence:
          enabled: false
    typesense:
      enabled: true
      persistence:
        tsdata:
          enabled: true
          type: emptyDir

    machine-learning:
      controller:
        strategy: RollingUpdate
        rollingUpdate:
          unavailable: "0"
      resources:
        requests:
          cpu: 10m
        limits:
          cpu: 3
          ephemeral-storage: 10Gi
      # issue doesn't seem to be resolved
      # immich-app/immich-charts#27
      probes:
        liveness:
          spec:
            initialDelaySeconds: 60
      podAnnotations:
        instrumentation.opentelemetry.io/inject-python: "true"
      # OTel overrides PYTHONPATH: open-telemetry/opentelemetry-operator#1884
      # so we add the expected path manually
      # https://github.com/immich-app/immich/blob/main/machine-learning/Dockerfile
      command:
      - /bin/sh
      args:
      - -c
      - "PYTHONPATH=$PYTHONPATH:/usr/src tini -- ./start.sh"
      # persistence:
      #   cache:
      #     # 10Gi, avoid downloading ML models every startup
      #     type: pvc
      #     accessMode: ReadWriteOnce

    microservices:
      controller:
        strategy: RollingUpdate
        rollingUpdate:
          unavailable: "0"
      podAnnotations:
        instrumentation.opentelemetry.io/inject-nodejs: "true"

    server:
      controller:
        strategy: RollingUpdate
        rollingUpdate:
          unavailable: "0"
      podAnnotations:
        instrumentation.opentelemetry.io/inject-nodejs: "true"

    web:
      controller:
        strategy: RollingUpdate
        rollingUpdate:
          unavailable: "0"
      podAnnotations:
        instrumentation.opentelemetry.io/inject-nodejs: "true"
        
    image:
      # quotes are required for regex
      # datasource=github-releases depName=immich-app/immich
      tag: "v1.78.1"

    # chart can't create PVC for library?
    immich:
      persistence:
        library:
          existingClaim: immich-library
    # affinity for ReadWriteOnce library volume
    affinity:
      podAffinity: 
        requiredDuringSchedulingIgnoredDuringExecution: 
        - labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/instance
              operator: In 
              values:
              - immich 
          topologyKey: kubernetes.io/hostname
