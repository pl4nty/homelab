apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: json-exporter
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: prometheus-json-exporter
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: grafana
  values:
    serviceMonitor:
      enabled: true
      targets:
      - name: mcc
        url: http://mcc:5000/summary
      defaults:
        interval: 1m
    configuration:
      config: |
        ---
        modules:
          default:
            metrics:
            - name: mcc
              path: "{.canonicalHosts_Allowed_HitCount}"
              help: Per-second stats aggregated over a minute
              values:
                mcc_test: "{.DCSFE\.PROD\.ADU\.MICROSOFT\.COM}"
    # mcc_hits: "{.aggregated_PerSecondStats.hits}"
    # mcc_misses: "{.aggregated_PerSecondStats.misses}"
    # mcc_stale: "{.aggregated_PerSecondStats.stale}"
    # mcc_updating: "{.aggregated_PerSecondStats.updating}"
    # mcc_hitRps: "{.aggregated_PerSecondStats.hitRps}"
    # mcc_missRps: "{.aggregated_PerSecondStats.missRps}"
    # mcc_hitMbps: "{.aggregated_PerSecondStats.hitMbps}"
    # mcc_missMbps: "{.aggregated_PerSecondStats.missMbps}"
    # mcc_hitBytesSum_Accumulator: "{.aggregated_PerSecondStats.hitBytesSum_Accumulator}"
    # mcc_requestDurationInMs_Accumulator: "{.aggregated_PerSecondStats.requestDurationInMs_Accumulator}"
    # mcc_requestDurationCountAccumulator: "{.aggregated_PerSecondStats.requestDurationCountAccumulator}"