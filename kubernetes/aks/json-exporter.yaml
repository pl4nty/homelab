apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: json-exporter
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: prometheus-json-exporter
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: grafana
  values:
    serviceMonitor:
      enabled: true
      targets:
      - name: mcc
        url: mcc.svc.cluster.local:5000/summary
    configuration:
      config: |
        ---
        modules:
          default:
            metrics:
            - name: mcc
              path: "{ .aggregated_PerSecondStats }"
              help: Per-second stats aggregated over a minute
              values:
                mcc_hits: "{.hits}"
                mcc_misses: "{.misses}"
                mcc_stale: "{.stale}"
                mcc_updating: "{.updating}"
                mcc_hitRps: "{.hitRps}"
                mcc_missRps: "{.missRps}"
                mcc_hitMbps: "{.hitMbps}"
                mcc_missMbps: "{.missMbps}"
                mcc_hitBytesSum_Accumulator: "{.hitBytesSum_Accumulator}"
                mcc_requestDurationInMs_Accumulator: "{.requestDurationInMs_Accumulator}"
                mcc_requestDurationCountAccumulator: "{.requestDurationCountAccumulator}"