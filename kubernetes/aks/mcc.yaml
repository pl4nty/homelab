apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcc
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mcc
  template:
    metadata:
      labels:
        app: mcc
    spec:
      imagePullSecrets:
      - name: mcc-registry
      containers:
      - name: mcc
        image: msconnectedcacheprod.azurecr.io/mcc/linux/iot/mcc-ubuntu-iot-amd64:1.2.1.1332
        resources:
          requests:
            cpu: 50m
            memory: 600Mi
          limits:
            cpu: 100m
            memory: 1Gi
        ports:
        - containerPort: 8081
        - containerPort: 5000
        env:
        - name: CUSTOMER_ID
          valueFrom:
            secretKeyRef:
              name: mcc-env
              key: CUSTOMER_ID
        - name: CUSTOMER_KEY
          valueFrom:
            secretKeyRef:
              name: mcc-env
              key: CUSTOMER_KEY
        - name: CACHE_NODE_ID
          valueFrom:
            secretKeyRef:
              name: mcc-env
              key: CACHE_NODE_ID
        - name: IS_SUMMARY_PUBLIC
          value: 'true'
        - name: IS_SUMMARY_ACCESS_UNRESTRICTED
          value: 'true'
        - name: X_CID
          value: '10000'
        - name: STORAGE_1_SIZE_GB
          value: '10'
        volumeMounts:
        - name: cache-1
          mountPath: /nginx/cache1
      volumes:
      - name: cache-1
        persistentVolumeClaim:
          claimName: mcc-cache-1
      # avoid trying to mount WriteOnce PVC across nodes
      strategy:
        type: Recreate
      securityContext:
        fsGroup: 2000
        # net.* isn't allowlisted by default, but can be added
        # https://learn.microsoft.com/en-us/azure/aks/custom-node-configuration#kubelet-custom-configuration
        # sysctls:
        # - name: net.ipv4.tcp_max_tw_buckets
        #   value: '1440000'
        # - name: net.ipv4.ip_local_port_range
        #   value: '8193 65000'
        # - name: net.core.somaxconn
        #   value: '1024'
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mcc-cache-1
  namespace: default
spec:
  accessModes:
  - ReadWriteOnce
  storageClassName: default
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: Service
metadata:
  name: mcc
  namespace: default
spec:
  type: ClusterIP
  ports:
  - name: http
    port: 8081
  - name: metrics
    port: 5000
  selector:
    app: mcc
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: mcc
  namespace: default
spec:
  parentRefs:
  - name: gateway
    sectionName: http
  hostnames:
  - cache.tplant.au
  rules:
  - backendRefs:
    - name: mcc
      port: 8081

